nixfiles
========

My [NixOS][] configuration and assorted other crap, powered by
[flakes][].  Clone to `/etc/nixos`.

See [the memo][] for machine-specific notes.

[NixOS]: https://nixos.org
[flakes]: https://nixos.wiki/wiki/Flakes
[the memo]: https://memo.barrucadu.co.uk/machines.html


Secrets
-------

Secrets are managed with [sops-nix][].  Create / edit secrets with:

```bash
nix run .\#secrets                   # secrets.yaml for current host
nix run .\#secrets <hostname>        # secrets.yaml for <hostname>
nix run .\#secrets <hostname> <name> # <name>.yaml for <hostname>
```

[sops-nix]: https://github.com/Mic92/sops-nix


Operational notes
-----------------

### Backups

Backups are generated by `shared/backups` and uploaded to S3 with Duplicity.

Check the status of a backup collection with:

```bash
nix run .\#backups                   # for the current host
nix run .\#backups status            # for the current host
nix run .\#backups status <hostname> # for another host
```

Restore a backup to `~/tmp/backup-restore` with:

```bash
nix run .\#backups restore            # for the current host
nix run .\#backups restore <hostname> # for another host
```

Change the restore target by setting `$RESTORE_DIR`.

### ZFS

If there are any ZFS filesystems, the auto-trim, -scrub, and -snapshot jobs will
be enabled, as well as a Prometheus alert for if a pool becomes unhealthy (if
Alertmanager is enabled on this host).

Enable the auto-trim for a pool with:

```bash
sudo zpool set autotrim=on <pool>
```

Enable the auto-snapshot for a dataset with:

```bash
sudo zfs set com.sun:auto-snapshot=true <dataset>
```

The auto-scrub and the alert apply to all pools.
